# malwarETL-prefect
settings used to install Prefect in a k8s cluster.

This uses the prefect helm charts, and the postgres DB and MetalLB loadbalancer installed with the malwarETL 
k8s cluster. 

You will need to create a postgres user and DB for prefect before installing the server. You can do that by
applying the `kubernetes/postgres-secret.yaml` file to the postgres namespace, and then applying the 
`setup/prefect-db-setup-job` to the same postgres namespace. (you can remove the postgres-secret from the 
postgres namespace after the job is done.)

You should also create the prefect-server and prefect-agent namespaces by applying the two namespace yaml files.
Then, in the server namespace, apply the postgres-secret yaml, and in the agent namespace, apply the smb-secrets
and *-pv.yaml files.

You'll then need to set up helm for prefect:
```
helm repo add prefect https://prefecthq.github.io/prefect-helm
helm repo update
```
After that, edit the `helm/server-values.yaml` file, and then install with helm like
```
helm install prefect-server prefect/prefect-server --namespace=prefect-server -f server-values.yaml
```
(make sure to point the -f part at the path to your server-values file)
Then, before anything else, you'll need to make sure that the IP address you assigned to the prefect-server
has working DNS, and that it matches the data you put in the server-values.yaml file. 

If you did that, then you should be able to point a browser at the URL for the system (like, 
`http://prefect-server.example.com`) and the prefect ui should load. 

You will next need to install the agent. It's pretty much the same process: edit the agent-values file
to make sure it points to the server you just installed, then:
```
helm install prefect-agent prefect/prefect-agent --namespace=prefect-agent -f agent-values.yaml
```

There is, sadly, one setup that can't be automated. You will need to create a storage block to allow
Prefect to store the code that you want to deploy. I made that with another SMB share (since that's what
everything else is), but had to define that in the prefect UI manually. 

## Using prefect

Once you have this all set up, you'll need to set your prefect config to point to the new server on your 
development box. I did this with 
```
prefect config set --profile default PREFECT_API_URL="http://<public url here>"
```