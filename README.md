# malwarETL-prefect
settings used to install Prefect in a k8s cluster.

These are both installed via helm, so the kubernetes directory holds the values.yaml overrides to the default
helm settings for both prefect and postgresql.

The "prefect-db-setup-job" is a one-off k8s job to create the prefect username and db in postgres and a prefect
user in elasticsearch.


NOTE on the postgres pod: part of the initial purpose of all of the cfs-smb work was to move away from using NFS
as a storage layer. This ran head-first into reality. The problem:
 * SMB does not support changing ownership of directories by remote mounts. This is by design of the protocol
 * postgres insists on running as non root. This is reasonable.
 * k8s mounts remote mounts as root. This is...ok, I guess?
 * postgres tries to chown its data dir to its configured non-root user, so that it can modify files in its data store
 * this fails due to the first bullet above. 
 * running an init container to chown the directory doesn't help, since the chown is explictly refused.

NFS, however, does not have a problem with you changing ownership of mounted directories. It's a hell-hole of other
security problems, but this makes it work. I hate it, but yes, to get postgres to work, I'm using nfs. 

dammit.

(reference: https://stackoverflow.com/questions/60192819/cant-get-either-postgres-permissions-or-pvc-working-in-aks)


