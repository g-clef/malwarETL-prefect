import os
import requests


def setup_es():
    username = os.environ.get("PREFECT_ES_USER", "prefect")
    password = os.environ.get("PREFECT_ES_PASS", None)
    elastic_user = os.environ.get("ELASTIC_USER", "elastic")
    elastic_pass = os.environ.get("ELASTIC_PASS", None)
    post_data = {"password": password,
                 "roles": "superuser"
                 }
    response = requests.post(f"https://malwaretl-cluster-es-http.es:9200/_security/user/{username}",
                             json=post_data,
                             auth=(elastic_user, elastic_pass),
                             verify=False)
    if response.status_code not in (200, 201):
        raise Exception(f"problem with user creation: {response.json()}")


def main():
    setup_es()


if __name__ == "__main__":
    main()
